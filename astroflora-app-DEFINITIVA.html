<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ AstroFlora Driver AI - APLICACI√ìN DEFINITIVA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        
        .header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 3.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #ffffff, #a8d5ff);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: rgba(0, 0, 0, 0.2);
            font-size: 14px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.online {
            background: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }
        
        .status-dot.offline {
            background: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 200px);
        }
        
        .chat-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            max-width: 85%;
        }
        
        .message.user {
            background: linear-gradient(45deg, #007bff, #0056b3);
            margin-left: auto;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }
        
        .message.assistant {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-left: 6px solid #28a745;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .message.error {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border-left: 6px solid #ff6b6b;
        }
        
        .message-header {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .message-content {
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .input-section {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .input-group {
            flex: 1;
        }
        
        .chat-input {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        .send-button {
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .send-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
        }
        
        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .panel h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #a8d5ff;
        }
        
        .quick-actions {
            display: grid;
            gap: 10px;
        }
        
        .quick-action {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-align: left;
        }
        
        .quick-action:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
        
        .system-info {
            font-size: 12px;
            line-height: 1.5;
        }
        
        .system-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-size: 1.1em;
        }
        
        .spinner {
            width: 25px;
            height: 25px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .connection-test {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 11px;
        }
        
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ AstroFlora Driver AI</h1>
        <p style="font-size: 1.2em; opacity: 0.9;">Sistema de An√°lisis Cient√≠fico con IA Avanzada</p>
    </div>
    
    <div class="status-bar">
        <div class="status-indicator">
            <div id="backendStatus" class="status-dot offline"></div>
            <span id="statusText">Conectando al backend...</span>
        </div>
        <div>
            <span id="sessionInfo">Sesi√≥n: astroflora_definitiva_${Date.now()}</span>
        </div>
        <div>
            <span id="timestamp">${new Date().toLocaleString()}</span>
        </div>
    </div>
    
    <div class="main-container">
        <div class="chat-panel">
            <div id="chatMessages" class="chat-messages">
                <div class="message assistant">
                    <div class="message-header">üß¨ AstroFlora Driver AI</div>
                    <div class="message-content">¬°Bienvenido al sistema AstroFlora Driver AI! 

Este es el sistema definitivo integrado con:
‚Ä¢ Conexi√≥n real al backend 3.85.5.222:8001
‚Ä¢ Procesamiento con OpenAI GPT-4o
‚Ä¢ An√°lisis cient√≠fico especializado
‚Ä¢ Bases de datos ChEMBL, UniProt, PDB

Puede realizar consultas sobre:
üß¨ An√°lisis de prote√≠nas y secuencias
üî¨ Consultas cient√≠ficas especializadas  
üíä Investigaci√≥n farmacol√≥gica
üìä Bioinform√°tica y an√°lisis molecular

¬øEn qu√© puedo ayudarle hoy?</div>
                </div>
            </div>
            
            <div class="input-section">
                <div class="input-group">
                    <textarea 
                        id="messageInput" 
                        class="chat-input"
                        placeholder="üß¨ Escriba su consulta cient√≠fica aqu√≠...

Ejemplos:
‚Ä¢ ¬øQu√© es la prote√≠na BRAF y su relevancia oncol√≥gica?
‚Ä¢ Analice la secuencia ATCGATCGATCG
‚Ä¢ ¬øC√≥mo funciona el mecanismo de CRISPR?
‚Ä¢ Busque informaci√≥n sobre el compuesto aspirin en ChEMBL"
                    ></textarea>
                </div>
                <button id="sendButton" class="send-button" onclick="sendMessage()">
                    üöÄ Enviar
                </button>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="panel">
                <h3>üéØ Consultas R√°pidas</h3>
                <div class="quick-actions">
                    <button class="quick-action" onclick="quickQuery('¬øQu√© es la prote√≠na BRAF y su relevancia en oncolog√≠a?')">
                        üß¨ An√°lisis Prote√≠na BRAF
                    </button>
                    <button class="quick-action" onclick="quickQuery('Explique el mecanismo de acci√≥n de CRISPR-Cas9')">
                        ‚úÇÔ∏è Mecanismo CRISPR
                    </button>
                    <button class="quick-action" onclick="quickQuery('Busque informaci√≥n del compuesto aspirin en bases de datos')">
                        üíä B√∫squeda Aspirin
                    </button>
                    <button class="quick-action" onclick="quickQuery('¬øCu√°les son las aplicaciones de PCR en diagn√≥stico?')">
                        üî¨ Aplicaciones PCR
                    </button>
                    <button class="quick-action" onclick="quickQuery('Analice la secuencia de ADN: ATGCGATCGTAGC')">
                        üß¨ An√°lisis Secuencia
                    </button>
                </div>
            </div>
            
            <div class="panel">
                <h3>üìä Estado del Sistema</h3>
                <div class="system-info">
                    <div>
                        <span>Backend:</span>
                        <span id="backendUrl">3.85.5.222:8001</span>
                    </div>
                    <div>
                        <span>Modelo IA:</span>
                        <span>OpenAI GPT-4o</span>
                    </div>
                    <div>
                        <span>Bases de Datos:</span>
                        <span>ChEMBL, UniProt, PDB</span>
                    </div>
                    <div>
                        <span>Latencia:</span>
                        <span id="latency">- ms</span>
                    </div>
                    <div>
                        <span>Mensajes:</span>
                        <span id="messageCount">0</span>
                    </div>
                </div>
                
                <div class="connection-test">
                    <div id="connectionStatus">üîÑ Verificando conexi√≥n...</div>
                    <button onclick="testConnection()" style="margin-top: 8px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 11px;">
                        üîç Probar Conexi√≥n
                    </button>
                </div>
            </div>
            
            <div class="panel">
                <h3>üõ†Ô∏è Herramientas</h3>
                <div class="quick-actions">
                    <button class="quick-action" onclick="clearChat()">
                        üóëÔ∏è Limpiar Chat
                    </button>
                    <button class="quick-action" onclick="exportChat()">
                        üíæ Exportar Conversaci√≥n
                    </button>
                    <button class="quick-action" onclick="showHelp()">
                        ‚ùì Ayuda del Sistema
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n global
        const BACKEND_URL = 'http://3.85.5.222:8001';
        const SESSION_ID = `astroflora_definitiva_${Date.now()}`;
        let messageCounter = 0;
        let isLoading = false;
        
        // Elementos DOM
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const backendStatus = document.getElementById('backendStatus');
        const statusText = document.getElementById('statusText');
        const messageCount = document.getElementById('messageCount');
        const latency = document.getElementById('latency');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // Inicializaci√≥n
        window.onload = function() {
            messageInput.focus();
            testConnection();
            updateTimestamp();
            setInterval(updateTimestamp, 1000);
            
            // Enter para enviar (Ctrl+Enter para nueva l√≠nea)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.ctrlKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        };
        
        // Funci√≥n principal para enviar mensajes
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isLoading) return;
            
            isLoading = true;
            updateSendButton(true);
            
            // Mostrar mensaje del usuario
            addMessage('user', message);
            messageInput.value = '';
            messageCounter++;
            updateMessageCount();
            
            try {
                const startTime = Date.now();
                
                // Enviar al backend REAL
                const response = await fetch(`${BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: SESSION_ID,
                        user_id: 'astroflora_user',
                        context: 'scientific_analysis'
                    })
                });
                
                const endTime = Date.now();
                const responseLatency = endTime - startTime;
                updateLatency(responseLatency);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Mostrar respuesta del backend
                let assistantMessage = '';
                if (data.response) {
                    assistantMessage = data.response;
                } else if (data.message) {
                    assistantMessage = data.message;
                } else if (data.text) {
                    assistantMessage = data.text;
                } else {
                    assistantMessage = JSON.stringify(data, null, 2);
                }
                
                addMessage('assistant', assistantMessage, {
                    latency: responseLatency,
                    timestamp: new Date().toISOString(),
                    backend: 'Driver AI'
                });
                
                updateBackendStatus(true);
                
            } catch (error) {
                console.error('Error enviando mensaje:', error);
                
                addMessage('error', `‚ùå Error de conexi√≥n con el backend:
                
${error.message}

Posibles causas:
‚Ä¢ Backend no disponible
‚Ä¢ Problemas de red/CORS
‚Ä¢ Endpoint no implementado
‚Ä¢ Timeout de conexi√≥n

El equipo t√©cnico ha sido notificado del problema.`, {
                    error: error.name,
                    timestamp: new Date().toISOString()
                });
                
                updateBackendStatus(false);
            } finally {
                isLoading = false;
                updateSendButton(false);
                scrollToBottom();
            }
        }
        
        // Agregar mensaje al chat
        function addMessage(type, content, metadata = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let headerText = '';
            switch (type) {
                case 'user':
                    headerText = 'üë§ Usuario';
                    break;
                case 'assistant':
                    headerText = `üß¨ ${metadata.backend || 'AstroFlora Driver AI'}`;
                    if (metadata.latency) {
                        headerText += ` ‚Ä¢ ${metadata.latency}ms`;
                    }
                    break;
                case 'error':
                    headerText = '‚ùå Error del Sistema';
                    break;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">${headerText}</div>
                <div class="message-content">${content}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Funciones de interfaz
        function updateSendButton(loading) {
            sendButton.disabled = loading;
            sendButton.innerHTML = loading ? 
                '<div class="spinner"></div> Enviando...' : 
                'üöÄ Enviar';
        }
        
        function updateBackendStatus(online) {
            backendStatus.className = `status-dot ${online ? 'online' : 'offline'}`;
            statusText.textContent = online ? 
                'Backend conectado y operativo' : 
                'Backend desconectado';
        }
        
        function updateMessageCount() {
            messageCount.textContent = messageCounter;
        }
        
        function updateLatency(ms) {
            latency.textContent = `${ms} ms`;
        }
        
        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleString();
        }
        
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Funciones de consultas r√°pidas
        function quickQuery(query) {
            messageInput.value = query;
            messageInput.focus();
        }
        
        // Test de conexi√≥n
        async function testConnection() {
            connectionStatus.innerHTML = 'üîÑ Probando conexi√≥n...';
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'test de conectividad',
                        session_id: 'connection_test'
                    })
                });
                
                const endTime = Date.now();
                const testLatency = endTime - startTime;
                
                if (response.ok) {
                    connectionStatus.innerHTML = `‚úÖ Conectado (${testLatency}ms)`;
                    updateBackendStatus(true);
                    updateLatency(testLatency);
                } else {
                    throw new Error(`${response.status} ${response.statusText}`);
                }
                
            } catch (error) {
                connectionStatus.innerHTML = `‚ùå Error: ${error.message}`;
                updateBackendStatus(false);
            }
        }
        
        // Funciones de herramientas
        function clearChat() {
            if (confirm('¬øEst√° seguro de que desea limpiar toda la conversaci√≥n?')) {
                chatMessages.innerHTML = `
                    <div class="message assistant">
                        <div class="message-header">üß¨ AstroFlora Driver AI</div>
                        <div class="message-content">Chat limpiado. ¬øEn qu√© puedo ayudarle?</div>
                    </div>
                `;
                messageCounter = 0;
                updateMessageCount();
            }
        }
        
        function exportChat() {
            const messages = Array.from(chatMessages.children).map(msg => {
                const header = msg.querySelector('.message-header').textContent;
                const content = msg.querySelector('.message-content').textContent;
                return `${header}\n${content}\n\n`;
            }).join('');
            
            const blob = new Blob([`AstroFlora Driver AI - Conversaci√≥n Exportada\n${new Date().toLocaleString()}\n\n${messages}`], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `astroflora_chat_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function showHelp() {
            addMessage('assistant', `üõ†Ô∏è **Gu√≠a de Uso - AstroFlora Driver AI**

**Tipos de Consultas Soportadas:**

üß¨ **An√°lisis de Prote√≠nas:**
‚Ä¢ "¬øQu√© es la prote√≠na BRAF?"
‚Ä¢ "Analice la funci√≥n de p53"
‚Ä¢ "Estructura de la hemoglobina"

üî¨ **An√°lisis de Secuencias:**
‚Ä¢ "Analice la secuencia: ATGCGATCG"
‚Ä¢ "Traduzca esta secuencia de ADN"
‚Ä¢ "¬øQu√© marcos de lectura tiene esta secuencia?"

üíä **B√∫squedas en Bases de Datos:**
‚Ä¢ "Busque aspirin en ChEMBL"
‚Ä¢ "Informaci√≥n de UniProt para insulina"
‚Ä¢ "Estructura PDB de lisozima"

üõ†Ô∏è **Controles de Teclado:**
‚Ä¢ Enter: Enviar mensaje
‚Ä¢ Ctrl + Enter: Nueva l√≠nea
‚Ä¢ ESC: Limpiar campo de entrada

**Estado del Backend:** ${backendStatus.className.includes('online') ? 'Conectado' : 'Desconectado'}
**Sesi√≥n Actual:** ${SESSION_ID}`);
        }
        
        // Manejo de errores global
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
        });
        
        // Test autom√°tico inicial
        setTimeout(() => {
            console.log('üöÄ AstroFlora Driver AI - Sistema Definitivo Iniciado');
            testConnection();
        }, 1000);
    </script>
</body>
</html>
